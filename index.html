<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© - Ù…Ø­Ø·Ø© Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (for Excel export) - CDN link -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // Import getAnalytics

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null; // Will store the Firebase Auth UID
        window.analytics = null; // Global for analytics instance

        // Initialize Firebase and set up listeners
        window.initializeFirebase = async () => {
            try {
                // User-provided Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyChn7PR_u3Eqi23wREFrDGpsLky9d8LpnY",
                    authDomain: "nasria-maintenance.firebaseapp.com",
                    projectId: "nasria-maintenance",
                    storageBucket: "nasria-maintenance.firebasestorage.app",
                    messagingSenderId: "659878221941",
                    appId: "1:659878221941:web:9d62b1ed93676f886dc03c",
                    measurementId: "G-DJWE45ZC7H"
                };

                // Set window.appId from the provided firebaseConfig
                window.appId = firebaseConfig.appId; 
                console.log("Application ID (appId) being used:", window.appId); // Added for debugging appId

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                window.analytics = getAnalytics(window.firebaseApp); // Initialize Analytics

                // Sign in anonymously to ensure Firestore access if no user is logged in yet.
                // This is crucial for Firestore listeners to work, even if a specific user isn't logged in yet.
                try {
                    await signInAnonymously(window.auth);
                } catch (authError) {
                    if (authError.code === 'auth/admin-restricted-operation') {
                        console.error("Firebase Auth Error: Anonymous authentication is not enabled.", authError);
                        window.showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„Ø©. ÙŠØ±Ø¬Ù‰ ØªÙ…ÙƒÙŠÙ† "Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„Ø©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Authentication Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                        return; // Stop initialization if anonymous auth fails
                    } else {
                        throw authError; // Re-throw other authentication errors
                    }
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase User ID:", window.userId); // Added for debugging
                        // Setup Firestore listeners after authentication
                        window.setupFirestoreListeners();
                    } else {
                        window.userId = null;
                        console.log("No Firebase user is signed in.");
                        // Clear data if user logs out or session ends
                        window.machines = [];
                        window.maintenanceRecords = [];
                        window.users = [];
                        window.loggedInUser = null;
                        window.loggedInRole = null;
                        // Show login section if no user
                        window.showSection('login-section');
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                window.showModal('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase', `ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
            }
        };

        // Function to set up real-time listeners for data
        window.setupFirestoreListeners = () => {
            if (!window.db || !window.userId) {
                console.warn("Firestore or User ID not available for setting up listeners.");
                return;
            }

            // Using the explicit appId from firebaseConfig for collection paths
            const appIdFromConfig = window.appId; // Use the window.appId which is set from firebaseConfig
            console.log("Firestore Collection Path Base:", `artifacts/${appIdFromConfig}/public/data/`);
            console.log("Current Firebase User ID:", window.userId);


            // Listen for 'users' collection (public for app users)
            onSnapshot(collection(window.db, `artifacts/${appIdFromConfig}/public/data/app_users`), (snapshot) => {
                const fetchedUsers = [];
                snapshot.forEach(doc => {
                    fetchedUsers.push({ id: doc.id, ...doc.data() });
                });
                window.users = fetchedUsers;
                console.log("Users fetched:", window.users);
                if (window.loggedInUser && window.loggedInRole) { // Only re-render if already logged in
                    window.renderUsersTable();
                }
            }, (error) => {
                console.error("Error fetching users:", error);
                window.showModal('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', `ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
            });

            // Listen for 'machines' collection
            onSnapshot(collection(window.db, `artifacts/${appIdFromConfig}/public/data/machines`), (snapshot) => {
                const fetchedMachines = [];
                snapshot.forEach(doc => {
                    fetchedMachines.push({ id: doc.id, ...doc.data() });
                });
                window.machines = fetchedMachines;
                console.log("Machines fetched:", window.machines);
                if (window.loggedInUser && window.loggedInRole) { // Only re-render if already logged in
                    window.renderMachineTable();
                    window.populateMaintenanceDropdowns(); // Re-populate dropdowns as machines might change
                }
            }, (error) => {
                console.error("Error fetching machines:", error);
                window.showModal('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ù„Ø§Øª', `ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù„Ø§Øª: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
            });

            // Listen for 'maintenanceRecords' collection
            onSnapshot(collection(window.db, `artifacts/${appIdFromConfig}/public/data/maintenanceRecords`), (snapshot) => {
                const fetchedRecords = [];
                snapshot.forEach(doc => {
                    fetchedRecords.push({ id: doc.id, ...doc.data() });
                });
                window.maintenanceRecords = fetchedRecords;
                console.log("Maintenance Records fetched:", window.maintenanceRecords);
                if (window.loggedInUser && window.loggedInRole) { // Only re-render if already logged in
                    window.renderMaintenanceTable();
                }
            }, (error) => {
                console.error("Error fetching maintenance records:", error);
                window.showModal('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©', `ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
            });
        };

        // Make Firestore functions globally accessible for the main script
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getAnalytics = getAnalytics; // Make getAnalytics global
    </script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .disabled-button {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Custom styles for tables on small screens */
        @media (max-width: 768px) {
            .responsive-table table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                border: 1px solid #ccc;
                margin-bottom: 0.625em;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
                white-space: normal;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0.5rem;
                right: 6px;
                width: 45%;
                padding-left: 10px;
                white-space: nowrap;
                font-weight: bold;
                content: attr(data-label);
                text-align: right;
            }
            .responsive-table td:last-child {
                border-bottom: 0;
            }
        }
        .footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 font-cairo text-right">

    <!-- Modal for messages and confirmations -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center space-x-4 rtl:space-x-reverse">
                <!-- Buttons will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- Login Section -->
        <div id="login-section" class="hidden items-center justify-center min-h-screen bg-gradient-to-r from-blue-500 to-purple-600 w-full">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
                <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-8">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                        <input type="text" id="username" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 w-full">
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                        </button>
                    </div>
                </form>
                <p class="text-gray-600 text-center mt-6 text-sm">
                  Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…
                    Ø§Ù„Ù„Ù‡Ù… ØµÙ„ÙŠ Ø¹Ù„Ù‰ Ø³ÙŠØ¯Ù†Ø§ Ù…Ø­Ù…Ø¯ ÙˆØ¹Ù„Ù‰ Ø¢Ù„Ù‡ ÙˆØµØ­Ø¨Ù‡ ÙˆØ³Ù„Ù…
                    Ø§Ù‡Ù„Ø§ Ø¨ÙƒÙ… ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©
                </p>
                <div class="footer">powerd by Eng.Mohamad Aldakak</div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 p-4 hidden w-full">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl transform transition-all duration-300 hover:shadow-3xl">
                <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
                <p class="text-gray-700 text-center mb-6 text-lg">
                    Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ù†Ø§ØµØ±ÙŠØ©.
                </p>
                <p id="logged-in-user-info" class="text-gray-600 text-center text-sm mb-8">
                    <!-- User info will be displayed here -->
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 cursor-pointer flex flex-col items-center text-center border border-gray-200" onclick="showSection('machine-log-section')">
                        <span class="text-5xl mb-4">âš™ï¸</span>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø§Øª</h3>
                        <p class="text-gray-600 text-sm">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¢Ù„Ø§Øª.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 cursor-pointer flex flex-col items-center text-center border border-gray-200" onclick="showSection('maintenance-log-section')">
                        <span class="text-5xl mb-4">ğŸ› ï¸</span>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
                        <p class="text-gray-600 text-sm">Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©.</p>
                    </div>
                    <div id="account-management-card" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 cursor-pointer flex flex-col items-center text-center border border-gray-200" onclick="showSection('account-management-section')">
                        <span class="text-5xl mb-4">ğŸ‘¥</span>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
                        <p class="text-gray-600 text-sm">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù….</p>
                    </div>
                </div>
                 <div class="mt-8">
                    <button onclick="exportAllData()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 mb-4">
                        ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
                    </button>
                </div>
                <button onclick="logout()" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
                <div class="footer">powerd by Eng.Mohamad Aldakak</div>
            </div>
        </div>

        <!-- Machine Log Section -->
        <div id="machine-log-section" class="p-6 bg-white rounded-xl shadow-lg m-4 w-full max-w-4xl hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø§Øª</h2>

            <div id="machine-message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span id="machine-message-text" class="block sm:inline"></span>
            </div>

            <form id="add-machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                <div class="col-span-full text-xl font-semibold mb-4 text-gray-700">Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <div>
                    <label for="machine-workLocation" class="block text-gray-700 text-sm font-bold mb-2">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</label>
                    <input type="text" id="machine-workLocation" name="workLocation" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„" required>
                </div>
                <div>
                    <label for="machine-workPart" class="block text-gray-700 text-sm font-bold mb-2">Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„:</label>
                    <input type="text" id="machine-workPart" name="workPart" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„" required>
                </div>
                <div>
                    <label for="machine-name" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©:</label>
                    <input type="text" id="machine-name" name="machineName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©" required>
                </div>
                <div>
                    <label for="machine-code" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©:</label>
                    <input type="text" id="machine-code" name="machineCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©" required>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                        Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø©
                    </button>
                </div>
            </form>

            <div class="mb-6">
                <label for="search-machine" class="block text-gray-700 text-sm font-bold mb-2">Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø§Øª:</label>
                <input type="text" id="search-machine" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø§Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø¬Ø²Ø¡ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
            </div>

            <div class="flex justify-end mb-4 space-x-2 rtl:space-x-reverse">
                <button onclick="exportMachinesToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                    ØªØµØ¯ÙŠØ± Excel
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 responsive-table">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider machine-actions-header">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="machine-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Machine rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-8">
                <button onclick="showSection('dashboard-section')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
            </div>
            <div class="footer">powerd by Eng.Mohamad Aldakak</div>
        </div>

        <!-- Maintenance Log Section -->
        <div id="maintenance-log-section" class="p-6 bg-white rounded-xl shadow-lg m-4 w-full max-w-5xl hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>

            <div id="maintenance-message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span id="maintenance-message-text" class="block sm:inline"></span>
            </div>

            <form id="add-maintenance-record-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                <div class="col-span-full text-xl font-semibold mb-4 text-gray-700">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</div>
                <div>
                    <label for="maintenance-date" class="block text-gray-700 text-sm font-bold mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„:</label>
                    <input type="date" id="maintenance-date" name="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" required>
                </div>
                <div>
                    <label for="maintenance-workLocation" class="block text-gray-700 text-sm font-bold mb-2">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„:</label>
                    <select id="maintenance-workLocation" name="workLocation" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" required>
                        <option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>
                    </select>
                </div>
                <div>
                    <label for="maintenance-workPart" class="block text-gray-700 text-sm font-bold mb-2">Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„:</label>
                    <select id="maintenance-workPart" name="workPart" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" disabled required>
                        <option value="">Ø§Ø®ØªØ± Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</option>
                    </select>
                </div>
                <div>
                    <label for="maintenance-machineName" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¢Ù„Ø©:</label>
                    <select id="maintenance-machineName" name="machineName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" disabled required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø©</option>
                    </select>
                </div>
                <div>
                    <label for="maintenance-machineCode" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©:</label>
                    <input type="text" id="maintenance-machineCode" name="machineCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-100 leading-tight focus:outline-none focus:shadow-outline" readonly disabled>
                </div>
                <!-- New field: Maintenance Department -->
                <div>
                    <label for="maintenance-department" class="block text-gray-700 text-sm font-bold mb-2">Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                    <select id="maintenance-department" name="maintenanceDepartment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" required>
                        <option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
                        <option value="Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ">Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ</option>
                        <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                        <option value="ØªØ­ÙƒÙ…">ØªØ­ÙƒÙ…</option>
                    </select>
                </div>
                <div>
                    <label for="maintenance-performedWork" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°:</label>
                    <textarea id="maintenance-performedWork" name="performedWork" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°..." required></textarea>
                </div>
                <div>
                    <label for="maintenance-sparePartsUsed" class="block text-gray-700 text-sm font-bold mb-2">Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</label>
                    <textarea id="maintenance-sparePartsUsed" name="sparePartsUsed" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©..."></textarea>
                </div>
                <div>
                    <label for="maintenance-notes" class="block text-gray-700 text-sm font-bold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                    <textarea id="maintenance-notes" name="notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                </div>
                <!-- New field: Data Entry User -->
                <div>
                    <label for="maintenance-dataEntryUser" class="block text-gray-700 text-sm font-bold mb-2">Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                    <input type="text" id="maintenance-dataEntryUser" name="dataEntryUser" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-gray-100 leading-tight focus:outline-none focus:shadow-outline" readonly>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                        Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø©
                    </button>
                </div>
            </form>

            <div class="mb-6">
                <label for="search-maintenance" class="block text-gray-700 text-sm font-bold mb-2">Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©:</label>
                <input type="text" id="search-maintenance" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø§Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø¢Ù„Ø©ØŒ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°...">
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="export-start-date" class="block text-gray-700 text-sm font-bold mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                        <input type="date" id="export-start-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                    </div>
                    <div>
                        <label for="export-end-date" class="block text-gray-700 text-sm font-bold mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                        <input type="date" id="export-end-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                    </div>
                    <div class="flex items-end space-x-2 rtl:space-x-reverse">
                        <button onclick="exportMaintenanceToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 w-full">
                            Excel
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mb-4 space-x-2 rtl:space-x-reverse">
                <button onclick="renderMaintenanceTable()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 responsive-table">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¢Ù„Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</th> <!-- New Header -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th> <!-- New Header -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider maintenance-actions-header">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="maintenance-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Maintenance record rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-8">
                <button onclick="showSection('dashboard-section')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
            </div>
            <div class="footer">powerd by Eng.Mohamad Aldakak</div>
        </div>

        <!-- Account Management Section -->
        <div id="account-management-section" class="p-6 bg-white rounded-xl shadow-lg m-4 w-full max-w-3xl hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>

            <div id="account-message" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span id="account-message-text" class="block sm:inline"></span>
            </div>

            <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                <div class="col-span-full text-xl font-semibold mb-4 text-gray-700">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</div>
                <div>
                    <label for="new-username" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <input type="text" id="new-username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
                </div>
                <div>
                    <label for="new-password" class="block text-gray-700 text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="new-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                </div>
                <div class="col-span-full">
                    <label for="new-role" class="block text-gray-700 text-sm font-bold mb-2">Ø§Ù„Ø¯ÙˆØ±:</label>
                    <select id="new-role" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                        <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                        <option value="normal_admin">Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ</option>
                        <option value="admin">Ù…Ø³Ø¤ÙˆÙ„</option>
                    </select>
                </div>
                <div class="col-span-full flex justify-center mt-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                        Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                </div>
            </form>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 responsive-table">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¯ÙˆØ±</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- User rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-center mt-8">
                <button onclick="showSection('dashboard-section')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
            </div>
            <div class="footer">powerd by Eng.Mohamad Aldakak</div>
        </div>
    </div>

    <script>
        // Global data storage (now updated by Firestore listeners)
        window.machines = [];
        window.maintenanceRecords = [];
        window.users = []; // Stores user objects: { id, username, password, role }
        window.loggedInUser = null;
        window.loggedInRole = null;
        // The appId will be explicitly defined from the firebaseConfig below
        // window.appId is set in window.initializeFirebase from the firebaseConfig

        // --- Utility Functions ---

        // Function to show a custom modal (replaces alert/confirm)
        function showModal(title, message, buttons) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const modalButtons = document.getElementById('modal-buttons');
            modalButtons.innerHTML = ''; // Clear existing buttons

            buttons.forEach(btn => {
                const buttonElement = document.createElement('button');
                buttonElement.textContent = btn.text;
                buttonElement.className = `py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out ${btn.className || 'bg-blue-600 hover:bg-blue-700 text-white'}`;
                buttonElement.onclick = () => {
                    modal.classList.add('hidden');
                    if (btn.onClick) btn.onClick();
                };
                modalButtons.appendChild(buttonElement);
            });
            modal.classList.remove('hidden');
        }
        window.showModal = showModal; // Make global for Firebase module

        // Function to show a specific section and hide others
        function showSection(sectionId) {
            // Hide all main sections
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('machine-log-section').classList.add('hidden');
            document.getElementById('maintenance-log-section').classList.add('hidden');
            document.getElementById('account-management-section').classList.add('hidden');

            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) {
                sectionToShow.classList.remove('hidden');
                // Add flex for sections that should be centered with flexbox
                if(['login-section', 'dashboard-section'].includes(sectionId)){
                    sectionToShow.classList.add('flex');
                }
            }

            if (sectionId === 'machine-log-section') {
                renderMachineTable();
                // Hide/show add form and action buttons based on role
                const addMachineForm = document.getElementById('add-machine-form');
                const machineActionButtons = document.querySelectorAll('#machine-log-section .flex.justify-end.mb-4 button');
                
                // Only 'admin' and 'normal_admin' can add/edit/delete machines
                if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                    addMachineForm.classList.remove('hidden');
                    // Show all action buttons for admin and normal_admin
                    machineActionButtons.forEach(btn => btn.classList.remove('hidden'));
                } else {
                    addMachineForm.classList.add('hidden');
                    // For 'user' role, only show export button
                    machineActionButtons.forEach(btn => {
                        if (btn.onclick.toString().includes('exportMachinesToExcel')) { 
                            btn.classList.remove('hidden');
                        } else {
                            btn.classList.add('hidden');
                        }
                    });
                }
            }
            if (sectionId === 'maintenance-log-section') {
                renderMaintenanceTable(); // Render all records by default

                const addMaintenanceForm = document.getElementById('add-maintenance-record-form');
                const maintenanceWorkLocationSelect = document.getElementById('maintenance-workLocation');
                const maintenanceWorkPartSelect = document.getElementById('maintenance-workPart');
                const maintenanceMachineNameSelect = document.getElementById('maintenance-machineName');
                const maintenanceMachineCodeInput = document.getElementById('maintenance-machineCode');
                const maintenanceDataEntryUserInput = document.getElementById('maintenance-dataEntryUser'); // Get the new input

                // Reset and disable dependent dropdowns
                maintenanceWorkLocationSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>';
                maintenanceWorkPartSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</option>'; 
                maintenanceMachineNameSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø©</option>'; 
                maintenanceMachineCodeInput.value = '';
                maintenanceDataEntryUserInput.value = window.loggedInUser || ''; // Set current user for Data Entry

                maintenanceWorkLocationSelect.disabled = true;
                maintenanceWorkPartSelect.disabled = true;
                maintenanceMachineNameSelect.disabled = true;
                maintenanceMachineCodeInput.disabled = true; // Ensure code input is also disabled
                // maintenanceDataEntryUserInput should always be readonly, but enable/disable form group
                // No need to disable maintenanceDataEntryUserInput as it's readonly

                if (window.machines.length === 0) {
                    showMessage('maintenance-message', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø§Øª ÙÙŠ Ù‚Ø³Ù… "Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø§Øª" Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©.', 'error');
                    addMaintenanceForm.classList.add('hidden'); // Hide the form
                } else {
                    // Only populate dropdowns and enable form if machines exist AND user is admin or normal_admin
                    if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                        addMaintenanceForm.classList.remove('hidden');
                        populateMaintenanceDropdowns(); // Populate dropdowns only if machines exist
                        maintenanceWorkLocationSelect.disabled = false; // Enable location dropdown for admin/normal_admin
                    } else {
                        addMaintenanceForm.classList.add('hidden'); // Hide for non-admin
                        showMessage('maintenance-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©.', 'error');
                    }
                }

                // Hide/show action buttons based on role (export buttons usually visible for all)
                const maintenanceActionButtons = document.querySelectorAll('#maintenance-log-section .mb-6.p-4 button');
                maintenanceActionButtons.forEach(btn => {
                    if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin' || btn.onclick.toString().includes('exportMaintenanceToExcel')) {
                        btn.classList.remove('hidden');
                    } else {
                        btn.classList.add('hidden');
                    }
                });
            }
            if (sectionId === 'account-management-section') {
                if (window.loggedInRole !== 'admin') {
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.', [{ text: 'Ù…ÙˆØ§ÙÙ‚', onClick: () => showSection('dashboard-section') }]);
                    return;
                }
                renderUsersTable();
            }
            if (sectionId === 'dashboard-section') {
                document.getElementById('logged-in-user-info').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${window.loggedInUser} (${window.loggedInRole === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„' : (window.loggedInRole === 'normal_admin' ? 'Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ' : 'Ù…Ø³ØªØ®Ø¯Ù…')})`;
                // Account management card only visible for 'admin'
                document.getElementById('account-management-card').style.display = window.loggedInRole === 'admin' ? 'flex' : 'none';
            }
        }
        window.showSection = showSection; // Make global for Firebase module

        // Function to display a message within a section
        function showMessage(elementId, text, type = 'info') {
            const messageDiv = document.getElementById(elementId);
            const messageText = document.getElementById(elementId + '-text');
            messageText.textContent = text;
            messageDiv.className = 'p-4 mb-4 text-sm rounded-lg'; // Reset classes
            switch(type) {
                case 'success':
                    messageDiv.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                     messageDiv.classList.add('bg-red-100', 'text-red-800');
                    break;
                default:
                     messageDiv.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageDiv.classList.remove('hidden');
            setTimeout(() => hideMessage(elementId), 5000);
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // --- Authentication Functions ---
        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                // Ensure window.appId is set before using it in collection path
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                const usersCollectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/app_users`);
                const q = window.query(usersCollectionRef, window.where("username", "==", username), window.where("password", "==", password)); // In a real app, hash and compare passwords securely
                const querySnapshot = await window.getDocs(q);

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    window.loggedInUser = userData.username;
                    window.loggedInRole = userData.role;
                    showSection('dashboard-section');
                } else {
                    showModal('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                }
            } catch (error) {
                console.error("Error during login:", error);
                showModal('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
            }
        });

        function logout() {
            showModal('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', [
                { text: 'Ù†Ø¹Ù…', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: async () => {
                    try {
                        await window.auth.signOut(); // Sign out from Firebase Auth
                        window.loggedInUser = null;
                        window.loggedInRole = null;
                        window.location.reload(); // Reload the page to reset everything
                    } catch (error) {
                        console.error("Error during logout:", error);
                        showModal('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ${error.message}`, [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    }
                }},
                { text: 'Ø¥Ù„ØºØ§Ø¡', className: 'bg-gray-500 hover:bg-gray-600 text-white' }
            ]);
        }
        
        // --- Export All Data (from Firestore) ---
        async function exportAllData() {
            try {
                // Ensure window.appId is set before using it in collection path
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                const machinesSnapshot = await window.getDocs(window.collection(window.db, `artifacts/${window.appId}/public/data/machines`));
                const fetchedMachines = machinesSnapshot.docs.map(doc => doc.data());

                const maintenanceSnapshot = await window.getDocs(window.collection(window.db, `artifacts/${window.appId}/public/data/maintenanceRecords`));
                const fetchedMaintenanceRecords = maintenanceSnapshot.docs.map(doc => doc.data());

                const usersSnapshot = await window.getDocs(window.collection(window.db, `artifacts/${window.appId}/public/data/app_users`));
                const fetchedUsers = usersSnapshot.docs.map(doc => doc.data());

                const allData = { users: fetchedUsers, machines: fetchedMachines, maintenanceRecords: fetchedMaintenanceRecords };
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});

                // Use the File System Access API for saving
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'backup_firestore.json',
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] },
                    }],
                });
                const writableStream = await handle.createWritable();
                await writableStream.write(dataBlob);
                await writableStream.close();
                showModal('Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore Ø¨Ù†Ø¬Ø§Ø­!', [{text: 'Ø­Ø³Ù†Ù‹Ø§'}]);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showModal('Ø¥Ù„ØºØ§Ø¡', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ±.', [{text: 'Ù…ÙˆØ§ÙÙ‚'}]);
                } else {
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', `ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ù…Ù† Firestore: ${error.message}`, [{text: 'Ù…ÙˆØ§ÙÙ‚'}]);
                }
            }
        }

        // --- Machine Log Functions ---
        function renderMachineTable(filteredMachines = window.machines) {
            const tableBody = document.getElementById('machine-table-body');
            tableBody.innerHTML = '';
            // Adjust header visibility based on role
            const actionsHeader = document.querySelector('.machine-actions-header');
            const maintenanceLogHeader = document.querySelector('#machine-log-section thead tr th:last-child'); // Select the last th
            
            // Show/hide action buttons and headers based on admin or normal_admin role
            if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                actionsHeader.classList.remove('hidden');
            } else {
                actionsHeader.classList.add('hidden');
            }
            // Always show "Maintenance Log" column for all users
            maintenanceLogHeader.classList.remove('hidden');


            if (filteredMachines.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${(window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') ? 6 : 5}" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>`;
                return;
            }
            filteredMachines.forEach(machine => {
                const row = tableBody.insertRow();
                row.setAttribute('data-id', machine.id);
                let actionsHtml = '';
                if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                    actionsHtml = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <button onclick="editMachine('${machine.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteMachine('${machine.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-xs">Ø­Ø°Ù</button>
                        </td>`;
                } else {
                    actionsHtml = `<td class="hidden"></td>`; // Hide actions column for 'user'
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„">${machine.workLocation}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„">${machine.workPart}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©">${machine.machineName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©">${machine.machineCode}</td>
                    ${actionsHtml}
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©">
                        <button onclick="viewMachineMaintenance('${machine.machineCode}')" class="bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-lg text-xs">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø©</button>
                    </td>`;
            });
        }
        window.renderMachineTable = renderMachineTable; // Make global

        document.getElementById('add-machine-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('machine-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø§Øª.', 'error');
                return;
            }
            const newMachine = {
                workLocation: document.getElementById('machine-workLocation').value.trim(),
                workPart: document.getElementById('machine-workPart').value.trim(),
                machineName: document.getElementById('machine-name').value.trim(),
                machineCode: document.getElementById('machine-code').value.trim()
            };
            if (!newMachine.workLocation || !newMachine.workPart || !newMachine.machineName || !newMachine.machineCode) {
                showMessage('machine-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'error');
                return;
            }
            // Uniqueness check for machineCode on add
            if (window.machines.some(m => m.machineCode === newMachine.machineCode)) {
                showMessage('machine-message', 'ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø© Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ ÙØ±ÙŠØ¯.', 'error');
                return;
            }
            try {
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/machines`), newMachine);
                document.getElementById('add-machine-form').reset();
                showMessage('machine-message', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¢Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error adding machine:", e);
                showMessage('machine-message', `ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¢Ù„Ø©: ${e.message}`, 'error');
            }
        });

        async function editMachine(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('machine-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¢Ù„Ø§Øª.', 'error');
                return;
            }
            const row = document.querySelector(`#machine-table-body tr[data-id='${id}']`);
            const machine = window.machines.find(m => m.id === id);
            if (!row || !machine) return;
            row.innerHTML = `
                <td class="px-6 py-4" data-label="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„"><input type="text" value="${machine.workLocation}" class="w-full p-1 border rounded" id="edit-workLocation-${id}"></td>
                <td class="px-6 py-4" data-label="Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„"><input type="text" value="${machine.workPart}" class="w-full p-1 border rounded" id="edit-workPart-${id}"></td>
                <td class="px-6 py-4" data-label="Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©"><input type="text" value="${machine.machineName}" class="w-full p-1 border rounded" id="edit-machineName-${id}"></td>
                <td class="px-6 py-4" data-label="ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©"><input type="text" value="${machine.machineCode}" class="w-full p-1 border rounded" id="edit-machineCode-${id}"></td>
                <td class="px-6 py-4" data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                    <button onclick="saveMachine('${id}')" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">Ø­ÙØ¸</button>
                    <button onclick="cancelEditMachine()" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded-lg text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©">
                        <button onclick="viewMachineMaintenance('${machine.machineCode}')" class="bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-lg text-xs">Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø©</button>
                    </td>`;
        }
        async function saveMachine(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('machine-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¢Ù„Ø§Øª.', 'error');
                return;
            }
            const updatedMachine = {
                workLocation: document.getElementById(`edit-workLocation-${id}`).value.trim(),
                workPart: document.getElementById(`edit-workPart-${id}`).value.trim(),
                machineName: document.getElementById(`edit-machineName-${id}`).value.trim(),
                machineCode: document.getElementById(`edit-machineCode-${id}`).value.trim()
            };
            if (!updatedMachine.workLocation || !updatedMachine.workPart || !updatedMachine.machineName || !updatedMachine.machineCode) {
                showMessage('machine-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'error');
                return;
            }

            const currentMachineData = window.machines.find(m => m.id === id);

            // Check if machineCode has actually changed
            if (updatedMachine.machineCode !== currentMachineData.machineCode) {
                // If it changed, check if the new machineCode exists for ANY other machine
                if (window.machines.some(m => m.id !== id && m.machineCode === updatedMachine.machineCode)) {
                    showMessage('machine-message', 'ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¢Ù„Ø© Ø£Ø®Ø±Ù‰.', 'error');
                    return;
                }
            }

            try {
                // Ensure window.appId is set before using it in collection path
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                const machineRef = window.doc(window.db, `artifacts/${window.appId}/public/data/machines`, id);
                await window.setDoc(machineRef, updatedMachine, { merge: true }); // Use merge to avoid overwriting other fields if any
                showMessage('machine-message', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error updating machine:", e);
                showMessage('machine-message', `ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù„Ø©: ${e.message}`, 'error');
            }
        }
        function cancelEditMachine() { renderMachineTable(); }
        function deleteMachine(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('machine-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ø¢Ù„Ø§Øª.', 'error');
                return;
            }
            showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¢Ù„Ø©ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ø£ÙŠØ¶Ù‹Ø§.', [
                { text: 'Ù†Ø¹Ù…', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: async () => {
                    try {
                        // Ensure window.appId is set before using it in collection path
                        if (!window.appId) {
                            console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                            showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                            return;
                        }
                        const machineToDelete = window.machines.find(m => m.id === id);
                        if (machineToDelete) {
                            // Delete associated maintenance records
                            const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/maintenanceRecords`), window.where("machineCode", "==", machineToDelete.machineCode));
                            const snapshot = await window.getDocs(q);
                            const deletePromises = snapshot.docs.map(d => window.deleteDoc(window.doc(window.db, `artifacts/${appId}/public/data/maintenanceRecords`, d.id)));
                            await Promise.all(deletePromises);
                        }
                        // Delete the machine document
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/machines`, id));
                        showMessage('machine-message', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¢Ù„Ø© ÙˆØ³Ø¬Ù„Ø§ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } catch (e) {
                        console.error("Error deleting machine:", e);
                        showMessage('machine-message', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¢Ù„Ø©: ${e.message}`, 'error');
                    }
                }},
                { text: 'Ø¥Ù„ØºØ§Ø¡', className: 'bg-gray-500 hover:bg-gray-600 text-white' }
            ]);
        }
        document.getElementById('search-machine').addEventListener('input', function(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredMachines = window.machines.filter(machine => Object.values(machine).some(val => val.toString().toLowerCase().includes(searchTerm)));
            renderMachineTable(filteredMachines);
        });

        // Function to view maintenance records for a specific machine
        function viewMachineMaintenance(machineCode) {
            const filteredRecords = window.maintenanceRecords.filter(record => record.machineCode === machineCode);
            showSection('maintenance-log-section');
            renderMaintenanceTable(filteredRecords);
            showMessage('maintenance-message', `Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ø¢Ù„Ø© Ø°Ø§Øª Ø§Ù„ÙƒÙˆØ¯: ${machineCode}`, 'info');
        }


        // --- Maintenance Log Functions ---
        function renderMaintenanceTable(filteredRecords = window.maintenanceRecords) {
            const tableBody = document.getElementById('maintenance-table-body');
            tableBody.innerHTML = '';
            // Adjust header visibility based on role
            const actionsHeader = document.querySelector('.maintenance-actions-header');
            if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                actionsHeader.classList.remove('hidden');
            } else {
                actionsHeader.classList.add('hidden');
            }

            if (filteredRecords.length === 0) {
                // Adjusted colspan for the new columns
                tableBody.innerHTML = `<tr><td colspan="${(window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') ? 11 : 10}" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>`;
                return;
            }
            filteredRecords.forEach(record => {
                const row = tableBody.insertRow();
                row.setAttribute('data-id', record.id);
                row.classList.add('hover:bg-gray-50');
                let actionsHtml = '';
                if (window.loggedInRole === 'admin' || window.loggedInRole === 'normal_admin') {
                    actionsHtml = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            <button onclick="editMaintenanceRecord('${record.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteMaintenanceRecord('${record.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-xs">Ø­Ø°Ù</button>
                        </td>`;
                } else {
                    actionsHtml = `<td class="hidden"></td>`; // Hide actions column for 'user'
                }
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„">${record.workLocation}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„">${record.workPart}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø§Ù„Ø¢Ù„Ø©">${record.machineName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©">${record.machineCode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©">${record.maintenanceDepartment || ''}</td> <!-- Display new field -->
                    <td class="px-6 py-4 text-sm text-gray-900" data-label="Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°"><div class="max-w-xs truncate" title="${record.performedWork}">${record.performedWork}</div></td>
                    <td class="px-6 py-4 text-sm text-gray-900" data-label="Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±"><div class="max-w-xs truncate" title="${record.sparePartsUsed}">${record.sparePartsUsed}</div></td>
                    <td class="px-6 py-4 text-sm text-gray-900" data-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"><div class="max-w-xs truncate" title="${record.notes}">${record.notes}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">${record.dataEntryUser || ''}</td> <!-- Display new field -->
                    ${actionsHtml}`;
            });
        }
        window.renderMaintenanceTable = renderMaintenanceTable; // Make global

        function populateMaintenanceDropdowns() {
            const workLocationSelect = document.getElementById('maintenance-workLocation');
            const workPartSelect = document.getElementById('maintenance-workPart');
            const machineNameSelect = document.getElementById('maintenance-machineName');
            const machineCodeInput = document.getElementById('maintenance-machineCode');
            const dataEntryUserInput = document.getElementById('maintenance-dataEntryUser'); // Get data entry user input

            // Set current user for Data Entry field
            dataEntryUserInput.value = window.loggedInUser || '';

            // Reset and disable dependent dropdowns
            workPartSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</option>';
            machineNameSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø©</option>';
            machineCodeInput.value = '';

            workPartSelect.disabled = true;
            machineNameSelect.disabled = true;
            machineCodeInput.disabled = true;

            // Populate workLocation dropdown only once on initial load or if it's empty
            // This logic needs to be careful because onSnapshot will re-trigger this.
            // Ensure it only adds new options, or clears and re-adds. Clearing and re-adding is safer.
            workLocationSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</option>';
            [...new Set(window.machines.map(m => m.workLocation))].forEach(location => {
                workLocationSelect.innerHTML += `<option value="${location}">${location}</option>`;
            });
            workLocationSelect.disabled = false; // Enable location dropdown after populating
            
            // Event listeners for cascading dropdowns
            workLocationSelect.onchange = () => {
                const selectedLocation = workLocationSelect.value;
                workPartSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„</option>';
                machineNameSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø©</option>';
                machineCodeInput.value = '';

                workPartSelect.disabled = !selectedLocation;
                machineNameSelect.disabled = true;
                machineCodeInput.disabled = true;

                if (selectedLocation) {
                    [...new Set(window.machines.filter(m => m.workLocation === selectedLocation).map(m => m.workPart))].forEach(part => {
                        workPartSelect.innerHTML += `<option value="${part}">${part}</option>`;
                    });
                }
            };

            workPartSelect.onchange = () => {
                const selectedLocation = workLocationSelect.value;
                const selectedPart = workPartSelect.value;
                machineNameSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø©</option>';
                machineCodeInput.value = '';

                machineNameSelect.disabled = !selectedPart;
                machineCodeInput.disabled = true;

                if (selectedLocation && selectedPart) {
                    // Filter machines based on both location and part
                    const filteredMachinesByPart = window.machines.filter(m => m.workLocation === selectedLocation && m.workPart === selectedPart);
                    [...new Set(filteredMachinesByPart.map(m => m.machineName))].forEach(name => {
                        machineNameSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    });
                }
            };

            machineNameSelect.onchange = () => {
                const selectedLocation = workLocationSelect.value;
                const selectedPart = workPartSelect.value;
                const selectedMachineName = machineNameSelect.value;
                machineCodeInput.value = '';
                machineCodeInput.disabled = true; // Disable until a machine is truly selected

                if (selectedLocation && selectedPart && selectedMachineName) {
                    const selectedMachine = window.machines.find(m => m.workLocation === selectedLocation && m.workPart === selectedPart && m.machineName === selectedMachineName);
                    if (selectedMachine) {
                        machineCodeInput.value = selectedMachine.machineCode;
                        machineCodeInput.disabled = false; // Enable once a code is set
                    }
                }
            };
        }
        window.populateMaintenanceDropdowns = populateMaintenanceDropdowns; // Make global

        document.getElementById('add-maintenance-record-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('maintenance-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©.', 'error');
                return;
            }
            const newRecord = {
                date: document.getElementById('maintenance-date').value,
                workLocation: document.getElementById('maintenance-workLocation').value,
                workPart: document.getElementById('maintenance-workPart').value,
                machineName: document.getElementById('maintenance-machineName').value,
                machineCode: document.getElementById('maintenance-machineCode').value,
                maintenanceDepartment: document.getElementById('maintenance-department').value, // New field
                performedWork: document.getElementById('maintenance-performedWork').value.trim(),
                sparePartsUsed: document.getElementById('maintenance-sparePartsUsed').value.trim(),
                notes: document.getElementById('maintenance-notes').value.trim(),
                dataEntryUser: window.loggedInUser // New field, automatically populated
            };
            if (!newRecord.date || !newRecord.workLocation || !newRecord.workPart || !newRecord.machineName || !newRecord.performedWork || !newRecord.maintenanceDepartment) {
                showMessage('maintenance-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.', 'error');
                return;
            }
            try {
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/maintenanceRecords`), newRecord);
                document.getElementById('add-maintenance-record-form').reset();
                populateMaintenanceDropdowns(); // Re-populate dropdowns after adding a record
                showMessage('maintenance-message', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error adding maintenance record:", e);
                showMessage('maintenance-message', `ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${e.message}`, 'error');
            }
        });

        async function editMaintenanceRecord(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('maintenance-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error');
                return;
            }
            const row = document.querySelector(`#maintenance-table-body tr[data-id='${id}']`);
            const record = window.maintenanceRecords.find(r => r.id === id);
            if (!row || !record) return;

            // Options for maintenance department dropdown
            const departmentOptions = ['Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'ØªØ­ÙƒÙ…'].map(dep => 
                `<option value="${dep}" ${record.maintenanceDepartment === dep ? 'selected' : ''}>${dep}</option>`
            ).join('');

            row.innerHTML = `
                <td class="px-6 py-4" data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"><input type="date" value="${record.date}" class="w-full p-1 border rounded" id="edit-maintenance-date-${id}"></td>
                <td class="px-6 py-4" data-label="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„"><input type="text" value="${record.workLocation}" class="w-full p-1 border rounded" id="edit-maintenance-workLocation-${id}"></td>
                <td class="px-6 py-4" data-label="Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„"><input type="text" value="${record.workPart}" class="w-full p-1 border rounded" id="edit-maintenance-workPart-${id}"></td>
                <td class="px-6 py-4" data-label="Ø§Ù„Ø¢Ù„Ø©"><input type="text" value="${record.machineName}" class="w-full p-1 border rounded" id="edit-maintenance-machineName-${id}"></td>
                <td class="px-6 py-4" data-label="ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©"><input type="text" value="${record.machineCode}" class="w-full p-1 border rounded" id="edit-maintenance-machineCode-${id}"></td>
                <td class="px-6 py-4" data-label="Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©">
                    <select class="w-full p-1 border rounded" id="edit-maintenance-department-${id}">
                        ${departmentOptions}
                    </select>
                </td>
                <td class="px-6 py-4" data-label="Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°"><textarea class="w-full p-1 border rounded" id="edit-maintenance-performedWork-${id}">${record.performedWork}</textarea></td>
                <td class="px-6 py-4" data-label="Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±"><textarea class="w-full p-1 border rounded" id="edit-maintenance-sparePartsUsed-${id}">${record.sparePartsUsed}</textarea></td>
                <td class="px-6 py-4" data-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"><textarea class="w-full p-1 border rounded" id="edit-maintenance-notes-${id}">${record.notes}</textarea></td>
                <td class="px-6 py-4" data-label="Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"><input type="text" value="${record.dataEntryUser || ''}" class="w-full p-1 border rounded bg-gray-100" id="edit-maintenance-dataEntryUser-${id}" readonly></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                    <button onclick="saveMaintenanceRecord('${id}')" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">Ø­ÙØ¸</button>
                    <button onclick="cancelEditMaintenanceRecord()" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded-lg text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                </td>`;
        }
        async function saveMaintenanceRecord(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('maintenance-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error');
                return;
            }
            const updatedRecord = {
                date: document.getElementById(`edit-maintenance-date-${id}`).value,
                workLocation: document.getElementById(`edit-maintenance-workLocation-${id}`).value.trim(),
                workPart: document.getElementById(`edit-maintenance-workPart-${id}`).value.trim(),
                machineName: document.getElementById(`edit-maintenance-machineName-${id}`).value.trim(),
                machineCode: document.getElementById(`edit-maintenance-machineCode-${id}`).value.trim(),
                maintenanceDepartment: document.getElementById(`edit-maintenance-department-${id}`).value, // New field
                performedWork: document.getElementById(`edit-maintenance-performedWork-${id}`).value.trim(),
                sparePartsUsed: document.getElementById(`edit-maintenance-sparePartsUsed-${id}`).value.trim(),
                notes: document.getElementById(`edit-maintenance-notes-${id}`).value.trim(),
                dataEntryUser: document.getElementById(`edit-maintenance-dataEntryUser-${id}`).value // New field, read-only
            };
            if (!updatedRecord.date || !updatedRecord.workLocation || !updatedRecord.workPart || !updatedRecord.machineName || !updatedRecord.performedWork || !updatedRecord.maintenanceDepartment) {
                showMessage('maintenance-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©.', 'error');
                return;
            }
            try {
                // Ensure window.appId is set before using it in collection path
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                const recordRef = window.doc(window.db, `artifacts/${window.appId}/public/data/maintenanceRecords`, id);
                await window.setDoc(recordRef, updatedRecord, { merge: true });
                showMessage('maintenance-message', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error updating maintenance record:", e);
                showMessage('maintenance-message', `ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${e.message}`, 'error');
            }
        }
        function cancelEditMaintenanceRecord() { renderMaintenanceTable(); }
        function deleteMaintenanceRecord(id) {
            if (window.loggedInRole !== 'admin' && window.loggedInRole !== 'normal_admin') {
                showMessage('maintenance-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©.', 'error');
                return;
            }
            showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù‡Ø°Ø§ØŸ', [
                { text: 'Ù†Ø¹Ù…', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: async () => {
                    try {
                        // Ensure window.appId is set before using it in collection path
                        if (!window.appId) {
                            console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                            showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                            return;
                        }
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/maintenanceRecords`, id));
                        showMessage('maintenance-message', 'ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } catch (e) {
                        console.error("Error deleting maintenance record:", e);
                        showMessage('maintenance-message', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${e.message}`, 'error');
                    }
                }},
                { text: 'Ø¥Ù„ØºØ§Ø¡', className: 'bg-gray-500 hover:bg-gray-600 text-white' }
            ]);
        }
        document.getElementById('search-maintenance').addEventListener('input', function(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredRecords = window.maintenanceRecords.filter(record => Object.values(record).some(val => val.toString().toLowerCase().includes(searchTerm)));
            renderMaintenanceTable(filteredRecords);
        });
        
        // --- Excel Export Functions ---
        
        function exportMachinesToExcel() {
            if (window.machines.length === 0) {
                showModal('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                return;
            }
            const dataToExport = window.machines.map(m => ({
                'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„': m.workLocation,
                'Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„': m.workPart,
                'Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©': m.machineName,
                'ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©': m.machineCode,
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù„Ø§Øª");
            XLSX.writeFile(wb, "Ø³Ø¬Ù„_Ø§Ù„Ø¢Ù„Ø§Øª.xlsx");
        }

        // Modified to include search term filtering
        function getFilteredMaintenanceRecordsForExport() {
            let recordsToFilter = [...window.maintenanceRecords]; // Start with all records

            const searchTerm = document.getElementById('search-maintenance').value.toLowerCase();
            if (searchTerm) {
                recordsToFilter = recordsToFilter.filter(record => 
                    Object.values(record).some(val => val.toString().toLowerCase().includes(searchTerm))
                );
            }

            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;

            if (!startDate && !endDate) return recordsToFilter;

            return recordsToFilter.filter(record => {
                const recordDate = new Date(record.date);
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                if(start) start.setHours(0,0,0,0);
                if(end) end.setHours(23,59,59,999);
                if (start && end) return recordDate >= start && recordDate <= end;
                if (start) return recordDate >= start;
                if (end) return recordDate <= end;
                return false;
            });
        }

        function exportMaintenanceToExcel() {
            const recordsToExport = getFilteredMaintenanceRecordsForExport(); // Use the new function
            if (recordsToExport.length === 0) {
                showModal('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø£Ùˆ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                return;
            }
            const dataToExport = recordsToExport.map(r => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': r.date, 
                'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„': r.workLocation, 
                'Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù…Ù„': r.workPart, 
                'Ø§Ù„Ø¢Ù„Ø©': r.machineName, 
                'ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø©': r.machineCode, 
                'Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©': r.maintenanceDepartment, // New field
                'Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†ÙØ°': r.performedWork, 
                'Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©': r.sparePartsUsed, 
                'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': r.notes,
                'Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª': r.dataEntryUser // New field
            }));
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©");
            XLSX.writeFile(wb, "Ø³Ø¬Ù„_Ø§Ù„Ø¢Ù„Ø§Øª.xlsx");
        }

        // --- Account Management Functions ---
        function renderUsersTable() {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            if (window.users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>`;
                return;
            }
            window.users.forEach(user => {
                const row = tableBody.insertRow();
                row.setAttribute('data-id', user.id);
                let roleDisplay = '';
                if (user.role === 'admin') {
                    roleDisplay = 'Ù…Ø³Ø¤ÙˆÙ„';
                } else if (user.role === 'normal_admin') {
                    roleDisplay = 'Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ';
                } else {
                    roleDisplay = 'Ù…Ø³ØªØ®Ø¯Ù…';
                }

                let actionsHtml = '';
                // Only 'admin' can see and interact with edit/delete buttons for other users
                // A 'user' can only see their own row and edit their own password
                if (window.loggedInRole === 'admin') {
                    actionsHtml = `
                        <button onclick="editUser('${user.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="deleteUser('${user.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-lg text-xs">Ø­Ø°Ù</button>
                    `;
                } else if (window.loggedInRole === 'user' && user.username === window.loggedInUser) {
                    // User can only edit their own password
                    actionsHtml = `
                        <button onclick="editUser('${user.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                    `;
                } else {
                    actionsHtml = ''; // No actions for normal_admin in user management or for users on other user rows
                }

                // Only render rows for 'admin' or for the logged-in 'user'
                if (window.loggedInRole === 'admin' || (window.loggedInRole === 'user' && user.username === window.loggedInUser)) {
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-label="Ø§Ù„Ø¯ÙˆØ±">${roleDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                            ${actionsHtml}
                        </td>`;
                }
            });
        }
        window.renderUsersTable = renderUsersTable; // Make global

        document.getElementById('add-user-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (window.loggedInRole !== 'admin') {
                showMessage('account-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            const newUsername = document.getElementById('new-username').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const newRole = document.getElementById('new-role').value;
            if (!newUsername || !newPassword) {
                showMessage('account-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'error'); return;
            }
            if (window.users.some(u => u.username === newUsername)) {
                showMessage('account-message', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.', 'error'); return;
            }
            try {
                // Ensure window.appId is set before using it in collection path
                if (!window.appId) {
                    console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                    showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                    return;
                }
                // Add user to Firestore
                await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/app_users`), {
                    username: newUsername,
                    password: newPassword, // In a real app, hash this password!
                    role: newRole
                });
                document.getElementById('add-user-form').reset();
                showMessage('account-message', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error adding user:", e);
                showMessage('account-message', `ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${e.message}`, 'error');
            }
        });

        async function editUser(id) {
            const row = document.querySelector(`#users-table-body tr[data-id='${id}']`);
            const user = window.users.find(u => u.id === id);
            if (!row || !user) return;

            // Admin can edit all fields for any user
            // Normal user can only edit their own password
            if (window.loggedInRole === 'admin') {
                row.innerHTML = `
                    <td data-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><input type="text" value="${user.username}" class="w-full p-1 border rounded" id="edit-username-${id}"></td>
                    <td data-label="Ø§Ù„Ø¯ÙˆØ±">
                        <select class="w-full p-1 border rounded" id="edit-role-${id}">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>Ù…Ø³ØªØ®Ø¯Ù…</option>
                            <option value="normal_admin" ${user.role === 'normal_admin' ? 'selected' : ''}>Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Ù…Ø³Ø¤ÙˆÙ„</option>
                        </select>
                    </td>
                    <td data-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        <input type="password" placeholder="Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±" class="w-full p-1 border rounded" id="edit-password-${id}"></td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <button onclick="saveUser('${id}')" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">Ø­ÙØ¸</button>
                        <button onclick="cancelEditUser()" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded-lg text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                    </td>`;
            } else if (window.loggedInRole === 'user' && user.username === window.loggedInUser) {
                // User editing their own password
                row.innerHTML = `
                    <td data-label="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">${user.username}</td>
                    <td data-label="Ø§Ù„Ø¯ÙˆØ±">${user.role === 'user' ? 'Ù…Ø³ØªØ®Ø¯Ù…' : ''}</td>
                    <td data-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        <input type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" class="w-full p-1 border rounded" id="edit-password-${id}" required></td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <button onclick="saveUser('${id}')" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-lg text-xs mr-2 rtl:ml-2 rtl:mr-0">Ø­ÙØ¸</button>
                        <button onclick="cancelEditUser()" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded-lg text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                    </td>`;
            } else {
                // Should not happen if showSection logic is correct, but as a fallback
                showMessage('account-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
            }
        }
        async function saveUser(id) {
            // Ensure window.appId is set before using it in collection path
            if (!window.appId) {
                console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                return;
            }
            const userRef = window.doc(window.db, `artifacts/${window.appId}/public/data/app_users`, id);
            const currentUserData = window.users.find(u => u.id === id);

            let updatedUsername = currentUserData.username;
            let updatedRole = currentUserData.role;
            const updatedPassword = document.getElementById(`edit-password-${id}`).value.trim();

            if (window.loggedInRole === 'admin') {
                updatedUsername = document.getElementById(`edit-username-${id}`).value.trim();
                updatedRole = document.getElementById(`edit-role-${id}`).value;

                if (!updatedUsername) {
                    showMessage('account-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error'); return;
                }

                // Check if username has actually changed
                if (updatedUsername !== currentUserData.username) {
                    // If it changed, check if the new username exists for ANY other user
                    const usernameExistsForOther = window.users.some(u => u.username === updatedUsername && u.id !== id);
                    if (usernameExistsForOther) {
                        showMessage('account-message', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±.', 'error'); return;
                    }
                }
            } else if (window.loggedInRole === 'user' && currentUserData.username === window.loggedInUser) {
                // User can only update their own password
                if (!updatedPassword) {
                    showMessage('account-message', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.', 'error'); return;
                }
            } else {
                showMessage('account-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'error');
                return;
            }

            try {
                const updateData = {
                    username: updatedUsername,
                    role: updatedRole
                };
                if (updatedPassword) { // Only update password if a new one is provided
                    updateData.password = updatedPassword; // In a real app, hash this password!
                }
                
                await window.setDoc(userRef, updateData, { merge: true });
                showMessage('account-message', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch (e) {
                console.error("Error updating user:", e);
                showMessage('account-message', `ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${e.message}`, 'error');
            }
        }
        function cancelEditUser() { renderUsersTable(); }
        function deleteUser(id) {
            if (window.loggedInRole !== 'admin') {
                showMessage('account-message', 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.', 'error');
                return;
            }
            showModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ', [
                { text: 'Ù†Ø¹Ù…', className: 'bg-red-600 hover:bg-red-700 text-white', onClick: async () => {
                    const userToDelete = window.users.find(u => u.id === id);
                    if (userToDelete && userToDelete.username === window.loggedInUser) {
                        showModal('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]); return;
                    }
                    try {
                        // Ensure window.appId is set before using it in collection path
                        if (!window.appId) {
                            console.error("window.appId is not set. Cannot proceed with Firestore operations.");
                            showModal('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', [{ text: 'Ù…ÙˆØ§ÙÙ‚' }]);
                            return;
                        }
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/app_users`, id));
                        showMessage('account-message', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } catch (e) {
                        console.error("Error deleting user:", e);
                        showMessage('account-message', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${e.message}`, 'error');
                    }
                }},
                { text: 'Ø¥Ù„ØºØ§Ø¡', className: 'bg-gray-500 hover:bg-gray-600 text-white' }
            ]);
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            window.initializeFirebase(); // Initialize Firebase on DOMContentLoaded
            showSection('login-section'); // Show login section directly
        });
    </script>
</body>
</html>
